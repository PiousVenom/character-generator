#!/bin/bash

set -e

echo "ğŸ” Running code quality checks..."

# PHP CS Fixer
echo "ğŸ“ Checking code style with PHP CS Fixer..."
./vendor/bin/php-cs-fixer fix --dry-run --diff

if [ $? -ne 0 ]; then
    echo "âŒ PHP CS Fixer found violations."
    echo "ğŸ’¡ Run './vendor/bin/php-cs-fixer fix' to auto-fix."
    exit 1
fi
echo "âœ… PHP CS Fixer passed!"

# Larastan
echo "ğŸ”¬ Running static analysis with Larastan..."
./vendor/bin/phpstan analyse --memory-limit=2G

if [ $? -ne 0 ]; then
    echo "âŒ Larastan found errors."
    exit 1
fi
echo "âœ… Larastan passed!"

# Tests (optional - can be slow)
if [ "$RUN_TESTS" = "1" ]; then
    echo "ğŸ§ª Running tests..."
    php artisan test --parallel

    if [ $? -ne 0 ]; then
        echo "âŒ Tests failed."
        exit 1
    fi
    echo "âœ… Tests passed!"
fi

echo "ğŸ‰ All checks passed!"
exit 0
